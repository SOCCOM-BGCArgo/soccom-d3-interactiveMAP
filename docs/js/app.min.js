var div=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),data=null,rdata={},u2w={};function loadJSON(t){var e=new XMLHttpRequest;e.overrideMimeType("application/json"),e.open("GET","https://tlmaurer.github.io/soccom-d3-eg/data/SOCCOMtracks.json",!0),e.onreadystatechange=function(){4==e.readyState&&"200"==e.status&&t(e.responseText)},e.send(null)}var g=null,projection=null,pointmap={},pointuw={},allpoints=[],e=[],searchFloatFunction=function(t,e){var a=document.getElementById("mySearch").value,r=[];if(a>1e6)for(var n=0;n<pointmap[a].length;n++)r.push(allpoints[pointmap[a][n]]);else for(n=0;n<pointuw[a].length;n++)r.push(allpoints[pointuw[a][n]]);g.selectAll("circle").data(r).attr("cx",function(t){return projection([t.lon,t.lat])[0]}).attr("cy",function(t){return projection([t.lon,t.lat])[1]}).attr("fill",function(t,e){return t.idx==t.len-1?"orange":"purple"}).attr("r",function(t,e){return t.idx==t.len-1?"8px":"2px"}).attr("opacity",.5)};loadJSON(function(t){var e=0,a=["lightgray","lightgreen","lightskyblue","lightcyan","lightcoral","lightsteelblue"],r=0;(data=JSON.parse(t)).forEach(function(t){for(var a=0;a<t.LATS.length;a++)t.LATS[a]&&t.LONS[a]&&(allpoints.push({lat:t.LATS[a][0],lon:t.LONS[a][0]>=180?t.LONS[a][0]-360:t.LONS[a][0],date:t.DATES[a],wmo:t.WMO,uwid:t.UWID,idx:a,len:t.LATS.length,cnt:e%6}),0==a?(pointmap[t.WMO]=[r],pointuw[t.UWID]=[r]):(pointmap[t.WMO].push(r),pointuw[t.UWID].push(r)),r+=1);e+=1});var n=960,o=960;projection=d3.geo.stereographic().scale(700).rotate([0,90]).translate([480,480]).clipAngle(179.9999).clipExtent([[0,0],[n,o]]).precision(.1);var l=d3.behavior.drag().on("drag",function(t,e){t.x+=d3.event.dx,t.y+=d3.event.dy,d3.select(this).attr("transform",function(t,e){return"translate("+[t.x,t.y]+")"})}),i=d3.behavior.zoom().translate([480,480]).scale(700).scaleExtent([50,3e3]).on("zoom",function(){projection.translate(i.translate()).scale(i.scale()),g.selectAll("path").attr("d",p),g.append("path").datum(c).attr("class","graticule").attr("d",p),g.selectAll("circle").attr("transform",function(t){return"translate("+projection([t.Lon,t.Lat])+")"}).attr("cx",function(t){return projection([t.lon,t.lat])[0]}).attr("cy",function(t){return projection([t.lon,t.lat])[1]}).attr("r",function(t,e){return t.idx==t.len-1?"4px":"1px"}).attr("fill",function(t,e){return t.idx==t.len-1?Date.parse(d)-Date.parse(t.date)<2592e6?"seagreen":"red":"darkgray"}).attr("opacity",function(t,e){return t.idx==t.len-1?.8:.5}).on("mouseover",function(t,e){if(t.idx==t.len-1){div.transition().duration(100).style("opacity",.9),div.html("<strong>WMO</strong>: "+t.wmo+"<br/><strong>UWID</strong>: "+t.uwid+"<br/><strong>last lat</strong>: "+t.lat+"<br/><strong>last lon</strong>: "+t.lon+"<br/><strong>last date:"+t.date+'<br/><strong>Download QC data:<a target="_blank" href= "https://www3.mbari.org/lobo/Data/FloatVizData/qc/'+t.uwid+'SOOCNQC.txt">ODVtext</a>, <a target="_blank" href= "ftp://ftp.ifremer.fr/ifremer/argo/dac/aoml/'+t.wmo+"/"+t.wmo+'_Mprof.nc">ARGOnetcdf</a>').style("text-align","left").style("left",projection([t.lon,t.lat])[0]+10+"px").style("top",projection([t.lon,t.lat])[1]-90+"px").style("width","250px").style("height","85px"),d3.select(this).attr("fill","orange").attr("r","6px").attr("opacity",.5);for(var a=[],r=1;r<pointmap[t.wmo].length;r++)a.push(allpoints[pointmap[t.wmo][r]]);g.selectAll("circle").data(a).attr("cx",function(t){return projection([t.lon,t.lat])[0]}).attr("cy",function(t){return projection([t.lon,t.lat])[1]}).attr("fill","purple").attr("r","2px").attr("opacity",.5)}}).on("mouseout",function(t,e){if(t.idx==t.len-1){div.transition().duration(2500).style("opacity",0),Date.parse(d)-Date.parse(t.date)<2592e6?d3.select(this).attr("fill","seagreen").attr("r","4px").attr("opacity",.9):d3.select(this).attr("fill","red").attr("r","4px").attr("opacity",.9);for(var r=[],n=1;n<pointmap[t.wmo].length;n++)r.push(allpoints[pointmap[t.wmo][n]]);g.selectAll("circle").data(r).attr("cx",function(t){return projection([t.lon,t.lat])[0]}).attr("cy",function(t){return projection([t.lon,t.lat])[1]}).attr("fill",function(t,e){return a[t.cnt]}).attr("r","1px").attr("opacity",.5)}}),d3.csv("https://tlmaurer.github.io/soccom-d3-eg/data/dailyseaice.csv",function(t){for(var e=[],a=0,r=t.length-1;a<=r;a++)e.push([t[a].Lon,t[a].Lat]);var n=[];n.push({type:"LineString",coordinates:e});g.selectAll(".ice").data(n).enter().append("path").style("fill","#A9CCE3").style("opacity",.3).style("stroke","#A9CCE3").style("stroke-width",2).attr("d",p).text("Median ice extent")})}),c=d3.geo.graticule(),s=d3.select("body").append("svg").attr("width",n).attr("height",o),p=d3.geo.path().projection(projection);g=s.append("g"),s.call(l).call(i).call(i.event),g.append("path").datum(c).attr("class","graticule").attr("d",p);d3.time.format("%m/%d/%Y");var d=new Date;d3.time.day.offset(d,-30);d3.json("https://tlmaurer.github.io/soccom-d3-eg/data/world-110m2.json",function(t,e){g.selectAll("path",".graticule").data(topojson.object(e,e.objects.countries).geometries).enter().append("path").attr("d",p),g.selectAll("circle").data(allpoints).enter().append("circle").attr("cx",function(t){return projection([t.lon,t.lat])[0]}).attr("cy",function(t){return projection([t.lon,t.lat])[1]}).attr("r",function(t,e){return t.idx==t.len-1?"4px":"1px"}).attr("fill",function(t,e){return t.idx==t.len-1?Date.parse(d)-Date.parse(t.date)<2592e6?"seagreen":"red":"darkgray"}).attr("opacity",function(t,e){return t.idx==t.len-1?.8:.5}).on("mouseover",function(t,e){if(t.idx==t.len-1){div.transition().duration(100).style("opacity",.9),div.html("<strong>WMO</strong>: "+t.wmo+"<br/><strong>UWID</strong>: "+t.uwid+"<br/><strong>last lat</strong>: "+t.lat+"<br/><strong>last lon</strong>: "+t.lon+"<br/><strong>last date:"+t.date+'<br/><strong>Download QC data:<a target="_blank" href= "https://www3.mbari.org/lobo/Data/FloatVizData/qc/'+t.uwid+'SOOCNQC.txt">ODVtext</a>, <a target="_blank" href= "ftp://ftp.ifremer.fr/ifremer/argo/dac/aoml/'+t.wmo+"/"+t.wmo+'_Mprof.nc">ARGOnetcdf</a>').style("text-align","left").style("left",projection([t.lon,t.lat])[0]+10+"px").style("top",projection([t.lon,t.lat])[1]-90+"px").style("width","250px").style("height","85px"),d3.select(this).attr("fill","orange").attr("r","6px").attr("opacity",.5);for(var a=[],r=1;r<pointmap[t.wmo].length;r++)a.push(allpoints[pointmap[t.wmo][r]]);g.selectAll("circle").data(a).attr("cx",function(t){return projection([t.lon,t.lat])[0]}).attr("cy",function(t){return projection([t.lon,t.lat])[1]}).attr("fill","purple").attr("r","2px").attr("opacity",.5)}}).on("mouseout",function(t,e){if(t.idx==t.len-1){div.transition().duration(2500).style("opacity",0),Date.parse(d)-Date.parse(t.date)<2592e6?d3.select(this).attr("fill","seagreen").attr("r","4px").attr("opacity",.9):d3.select(this).attr("fill","red").attr("r","4px").attr("opacity",.9);for(var r=[],n=1;n<pointmap[t.wmo].length;n++)r.push(allpoints[pointmap[t.wmo][n]]);g.selectAll("circle").data(r).attr("cx",function(t){return projection([t.lon,t.lat])[0]}).attr("cy",function(t){return projection([t.lon,t.lat])[1]}).attr("fill",function(t,e){return a[t.cnt]}).attr("r","1px").attr("opacity",.5)}})}),d3.csv("https://tlmaurer.github.io/soccom-d3-eg/data/dailyseaice.csv",function(t){for(var e=[],a=0,r=t.length-1;a<=r;a++)e.push([t[a].Lon,t[a].Lat]);var n=[];n.push({type:"LineString",coordinates:e});g.selectAll(".ice").data(n).enter().append("path").style("fill","#A9CCE3").style("opacity",.3).style("stroke","#A9CCE3").style("stroke-width",2).attr("d",p).text("Median ice extent")})});var ordinal=d3.scale.ordinal().domain(["Active float","Inactive float","USNIC daily ice edge"]).range(["seagreen","red","#A9CCE3"]),legsvg=d3.select("#legend").append("svg");legsvg.append("g").attr("class","legendfloat").attr("transform","translate(20,20)");var legendflt=d3.legend.color().shape("path",d3.svg.symbol().type("circle").size(100)()).shapePadding(10).scale(ordinal);legsvg.select(".legendfloat").call(legendflt);